# 開発ベストプラクティス

## 概要

本ドキュメントでは、CMSプロジェクトにおける開発のベストプラクティスを定義します。これらのプラクティスは、コードの品質、保守性、セキュリティを確保し、チーム全体で一貫した開発を行うための指針となります。

## 目次

1. [一般的な原則](#一般的な原則)
2. [コーディング規約](#コーディング規約)
3. [バージョン管理](#バージョン管理)
4. [テスト](#テスト)
5. [セキュリティ](#セキュリティ)
6. [パフォーマンス](#パフォーマンス)
7. [ドキュメント](#ドキュメント)
8. [CI/CD](#cicd)
9. [コードレビュー](#コードレビュー)
10. [トラブルシューティング](#トラブルシューティング)

## 一般的な原則

### DRY (Don't Repeat Yourself)

- コードの重複を避け、再利用可能なコンポーネントやユーティリティを作成する
- 同じロジックが複数の場所に存在する場合は、共通のモジュールに抽出する
- 設定値やマジックナンバーは定数として定義する

### KISS (Keep It Simple, Stupid)

- シンプルで理解しやすいコードを書く
- 過度に複雑な実装は避け、必要に応じてリファクタリングする
- 一つの関数やメソッドは一つの責務のみを持つようにする

### YAGNI (You Aren't Gonna Need It)

- 現時点で必要のない機能は実装しない
- 将来の拡張性を考慮しつつも、過度な抽象化は避ける
- 要件に基づいた実装を行い、スコープクリープを防ぐ

### 関心の分離

- ビジネスロジック、データアクセス、プレゼンテーションを適切に分離する
- バックエンドとフロントエンドの責務を明確に分ける
- モジュール間の依存関係を最小限に保つ

## コーディング規約

### 共通

- インデントはスペース2文字（フロントエンド）またはスペース4文字（バックエンド）を使用する
- 行の長さは100文字以内に収める
- ファイル名はケバブケース（kebab-case）を使用する
- コメントは必要最小限にとどめ、コードの「なぜ」を説明する
- TODOコメントには担当者と期限を記載する（例：`// TODO(username): 2023-06-30までに実装する`）

### バックエンド（Python）

- [PEP 8](https://peps.python.org/pep-0008/)に準拠する
- 変数名、関数名はスネークケース（snake_case）を使用する
- クラス名はパスカルケース（PascalCase）を使用する
- 定数名は大文字のスネークケース（UPPER_SNAKE_CASE）を使用する
- 型ヒントを積極的に使用する
- Docstringはすべての関数、クラス、モジュールに記述する

```python
def calculate_total_price(items: List[Item], discount_rate: float = 0.0) -> float:
    """
    商品リストから合計金額を計算する

    Args:
        items: 商品リスト
        discount_rate: 割引率（0.0〜1.0）

    Returns:
        割引適用後の合計金額
    
    Raises:
        ValueError: 割引率が0.0〜1.0の範囲外の場合
    """
    if not 0.0 <= discount_rate <= 1.0:
        raise ValueError("割引率は0.0〜1.0の範囲で指定してください")
    
    total = sum(item.price for item in items)
    return total * (1 - discount_rate)
```

### フロントエンド（TypeScript/React）

- [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)に準拠する
- 変数名、関数名はキャメルケース（camelCase）を使用する
- コンポーネント名、クラス名はパスカルケース（PascalCase）を使用する
- インターフェース名は`I`プレフィックスを付けない
- 型名はパスカルケース（PascalCase）を使用する
- JSXの属性はダブルクォーテーション（"）を使用する
- コンポーネントは関数コンポーネントとして実装する
- Hooksを積極的に活用する

```typescript
interface UserProps {
  name: string;
  email: string;
  role: UserRole;
  onProfileUpdate: (user: User) => void;
}

const UserProfile: React.FC<UserProps> = ({ name, email, role, onProfileUpdate }) => {
  const [isEditing, setIsEditing] = useState<boolean>(false);
  
  const handleSubmit = (event: React.FormEvent) => {
    event.preventDefault();
    // 処理の実装
    setIsEditing(false);
  };
  
  return (
    <div className="user-profile">
      {/* JSXの実装 */}
    </div>
  );
};

export default UserProfile;
```

## バージョン管理

### ブランチ戦略

- Gitflow ワークフローを採用する
  - `main`: 本番環境のコード
  - `develop`: 開発環境のコード
  - `feature/*`: 新機能の開発
  - `bugfix/*`: バグ修正
  - `release/*`: リリース準備
  - `hotfix/*`: 緊急のバグ修正

### コミットメッセージ

- [Conventional Commits](https://www.conventionalcommits.org/)の形式に従う
- 以下のプレフィックスを使用する
  - `feat:` 新機能
  - `fix:` バグ修正
  - `docs:` ドキュメントのみの変更
  - `style:` コードの意味に影響しない変更（空白、フォーマット、セミコロンの欠落など）
  - `refactor:` バグ修正でも機能追加でもないコード変更
  - `perf:` パフォーマンスを向上させるコード変更
  - `test:` 不足しているテストの追加や既存のテストの修正
  - `chore:` ビルドプロセスやツールの変更
  - `ci:` CI設定ファイルとスクリプトの変更

```
feat(auth): ソーシャルログイン機能の追加

- Googleログイン機能を追加
- Facebookログイン機能を追加
- ユーザープロフィールとの連携処理を実装

関連チケット: #123
```

### プルリクエスト

- プルリクエストは小さく保ち、一つの機能や修正に焦点を当てる
- プルリクエストのタイトルはコミットメッセージと同様の形式で記述する
- プルリクエストの説明には以下を含める
  - 変更の目的
  - 変更の概要
  - テスト方法
  - スクリーンショット（UI変更がある場合）
  - 関連するチケット番号
- レビュー前にセルフレビューを行い、不要なコードやデバッグ用のコードを削除する
- CIが成功していることを確認する

## テスト

### テスト戦略

- テストピラミッドに従い、単体テスト > 統合テスト > E2Eテストの比率を維持する
- テストカバレッジは80%以上を目標とする
- 重要なビジネスロジックは100%のカバレッジを目指す
- バグ修正時には、必ず再現テストを追加する

### 単体テスト

- バックエンドはpytestを使用する
- フロントエンドはJestとReact Testing Libraryを使用する
- モックとスタブを適切に使用し、外部依存を分離する
- テストケースは「準備（Arrange）」「実行（Act）」「検証（Assert）」のパターンに従う

```python
def test_calculate_total_price():
    # 準備（Arrange）
    items = [
        Item(name="商品A", price=100),
        Item(name="商品B", price=200),
        Item(name="商品C", price=300)
    ]
    discount_rate = 0.1
    
    # 実行（Act）
    result = calculate_total_price(items, discount_rate)
    
    # 検証（Assert）
    assert result == 540.0  # (100 + 200 + 300) * 0.9
```

### 統合テスト

- APIエンドポイントの統合テストを実施する
- データベースとの連携をテストする
- 外部サービスとの連携をテストする（モックサーバーを使用）
- テスト用のデータベースを使用し、テスト後にクリーンアップする

### E2Eテスト

- Playwrightを使用してE2Eテストを実施する
- 重要なユーザーフローを中心にテストする
- テスト環境は本番環境に近い構成にする
- テストデータは自動生成し、テスト後にクリーンアップする

## セキュリティ

### 認証と認可

- パスワードは必ずハッシュ化して保存する（bcryptを使用）
- 認証にはJWTを使用し、有効期限を適切に設定する
- 認可はロールベースのアクセス制御（RBAC）を実装する
- セッションIDは十分な長さと複雑さを持つようにする
- 多要素認証（MFA）をサポートする

### 入力検証

- すべてのユーザー入力を検証する
- バックエンドでの検証を必ず実装する（フロントエンドでの検証は利便性のため）
- SQLインジェクションを防ぐためにORMやパラメータ化クエリを使用する
- XSSを防ぐために適切なエスケープ処理を行う
- CSRFトークンを使用する

### データ保護

- 機密データは暗号化して保存する
- 環境変数やシークレットマネージャーを使用して認証情報を管理する
- 本番環境の認証情報をソースコードやバージョン管理に含めない
- 個人情報の取り扱いはプライバシーポリシーに従う
- データのバックアップと復元手順を確立する

### セキュリティヘッダー

- Content-Security-Policy (CSP)を設定する
- X-Content-Type-Options: nosniffを設定する
- X-Frame-Options: DENYを設定する
- Strict-Transport-Security (HSTS)を設定する
- X-XSS-Protection: 1; mode=blockを設定する

## パフォーマンス

### フロントエンド

- コンポーネントの不要な再レンダリングを防ぐ
- React.memoやuseMemoを適切に使用する
- 画像の最適化（WebP形式、適切なサイズ）を行う
- コードスプリッティングを実装する
- キャッシュ戦略を適切に設定する
- バンドルサイズを監視し、最小限に保つ

### バックエンド

- データベースクエリを最適化する
- インデックスを適切に設定する
- N+1問題を回避する
- キャッシュを活用する（Redis）
- 非同期処理を適切に実装する
- レスポンスのGzip圧縮を有効にする

### データベース

- 正規化と非正規化のバランスを取る
- 大量データの処理はバッチ処理やページネーションを使用する
- トランザクションを適切に使用する
- デッドロックを防ぐための設計を行う
- スロークエリを監視し、最適化する

## ドキュメント

### コード内ドキュメント

- 複雑なロジックには適切なコメントを追加する
- 関数やクラスにはドキュメントコメントを記述する
- APIエンドポイントにはOpenAPI/Swaggerドキュメントを作成する
- 型定義は明示的に行い、自己文書化コードを目指す

### プロジェクトドキュメント

- READMEには以下を含める
  - プロジェクトの概要
  - セットアップ手順
  - 開発環境の構築方法
  - テストの実行方法
  - デプロイ方法
- アーキテクチャドキュメントを作成し、システム全体の構成を説明する
- API仕様書を作成し、外部連携インターフェースを明確にする
- データベース設計書を作成し、テーブル構造と関連を説明する

## CI/CD

### 継続的インテグレーション（CI）

- すべてのプルリクエストに対して自動テストを実行する
- コードスタイルチェックを実施する（ruff, ESLint）
- 型チェックを実施する（mypy, TypeScript）
- セキュリティスキャンを実施する（Bandit, npm audit）
- テストカバレッジレポートを生成する

### 継続的デリバリー（CD）

- 開発環境への自動デプロイを実施する
- ステージング環境へのデプロイは手動承認後に実施する
- 本番環境へのデプロイは手動承認後に実施する
- デプロイ前後のヘルスチェックを実施する
- ロールバック手順を確立する

### 環境管理

- 開発、テスト、ステージング、本番の各環境を明確に分離する
- 環境ごとに適切な設定を行う
- 環境変数を使用して環境固有の設定を管理する
- インフラストラクチャをコードとして管理する（IaC）
- コンテナ化（Docker）を活用し、環境の一貫性を確保する

## コードレビュー

### レビュープロセス

- すべてのコード変更はレビューを受ける
- レビューは24時間以内に実施する
- レビューコメントは建設的かつ具体的に記述する
- 修正が必要な場合は明確な理由と改善案を提示する
- レビュー完了後にマージする

### レビューポイント

- 機能要件を満たしているか
- コーディング規約に準拠しているか
- テストが十分に書かれているか
- セキュリティ上の問題がないか
- パフォーマンスに問題がないか
- エラーハンドリングが適切か
- ドキュメントが更新されているか

### レビューツール

- GitHubのプルリクエスト機能を使用する
- コードレビューチェックリストを活用する
- 自動化ツール（SonarQube, CodeClimate）を活用する
- ペアプログラミングやモブプログラミングを適宜取り入れる

## トラブルシューティング

### デバッグ

- ログを適切に活用する
- 開発環境ではデバッグツールを活用する
- 問題の再現手順を明確にする
- 仮説を立て、検証する
- 根本原因を特定し、対処する

### ロギング

- ログレベル（DEBUG, INFO, WARNING, ERROR, CRITICAL）を適切に使い分ける
- 構造化ログを使用し、検索や分析を容易にする
- 個人情報や機密情報はログに記録しない
- ログローテーションを設定し、ディスク容量を管理する
- 集中ログ管理システムを活用する

### モニタリング

- アプリケーションのヘルスチェックを実装する
- パフォーマンスメトリクスを収集する
- エラー率を監視する
- レスポンスタイムを監視する
- リソース使用率（CPU, メモリ, ディスク）を監視する

## 参考資料

- [PEP 8 -- Style Guide for Python Code](https://peps.python.org/pep-0008/)
- [Airbnb JavaScript Style Guide](https://github.com/airbnb/javascript)
- [React Documentation](https://reactjs.org/docs/getting-started.html)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [OWASP Top Ten](https://owasp.org/www-project-top-ten/)
- [Twelve-Factor App](https://12factor.net/)
- [Conventional Commits](https://www.conventionalcommits.org/)
