# Git運用ルール

## ブランチ運用方針

### メインブランチ
- `main`: プロダクション環境にデプロイ可能な状態を維持
- 直接コミット禁止（Protected Branch設定必須）

### 作業用ブランチ
#### 命名規則
- 区切り文字はハイフン（`-`）を使用
  - 良い例: `feature/123-add-user-auth`
  - 悪い例: `feature/123_add_user_auth`
- 英数字のみを使用（日本語不可）
- 小文字のみを使用
- スペースは使用不可

#### ブランチ種別
- 命名規則: `feature/{issue番号}-{作業内容}`
  - 例: `feature/123-add-user-auth`
- バグ修正: `fix/{issue番号}-{修正内容}`
  - 例: `fix/456-login-error`
- リリース準備: `release/v{バージョン}`
  - 例: `release/v1.0.0`
- ホットフィックス: `hotfix/{issue番号}-{修正内容}`
  - 例: `hotfix/789-critical-security-fix`

### ブランチ運用ルール
1. 作業開始時は必ず最新の`main`からブランチを作成
   - ブランチ作成直後に初回コミットを行い、ドラフトのプルリクエスト（PRタイトルの接頭辞に"WIP_"を付与）を作成することを推奨する
     - 例: `WIP_OAuthによる認証機能の追加`
   - 初回コミットは空コミットでよい（`git commit --allow-empty -m "init"`）
   - 早期のPR作成により、作業の可視性を高め、重複作業を防ぐ
2. 作業中は適切な粒度でコミットを作成
   - 1つの論理的な変更を1つのコミットとする
   - 以下は1つのコミットとして扱う例：
     - 新しい機能の追加（関連するテストも含む）
     - バグ修正（テストケースの追加も含む）
     - リファクタリング（一連の変更をまとめて）
     - 設定ファイルの更新
   - 以下は分割すべき例：
     - 複数の機能追加
     - 無関係なファイルのフォーマット修正
     - 異なるバグの修正
3. メインブランチの変更の取り込み方
   - 基本方針：
     - `git merge main`による定期的なマージを推奨
     - コンフリクトを小さく保つため、1日1回程度の頻度でマージする
     - マージコミットは履歴として残し、作業の文脈を保持する
   - リベースについて：
     - リベースは操作が複雑になる場合が多いため、基本的にマージを推奨
     - プッシュ済みブランチのリベースは極力避ける（履歴の改変によりチーム作業に支障をきたす可能性あり）
     - リベースを実施した場合は、必ず`git push --force-with-lease`を使用する
       - `--force`は使用禁止（他の人の変更を誤って上書きする可能性あり）
4. マージ後は作業ブランチを削除（自動削除機能を使う）

## コミットメッセージ方針

### 基本形式
```
{type}: {概要}
```

### Type一覧
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメントのみの変更
- `style`: コードの意味に影響を与えない変更（空白、フォーマット等）
- `refactor`: リファクタリング
- `test`: テストコードの追加・修正
- `chore`: ビルドプロセスやツールの変更

### コミットメッセージ例
```
feat: ユーザー認証機能の追加
```

## GitHubとの連携方針

### ブランチ保護ルール
1. `main`ブランチへの直接プッシュを禁止
2. プルリクエストのレビュー承認を必須化
3. CIパイプラインの成功を必須化

### プルリクエストルール
1. 全てのプルリクエストは必ずイシューに紐付ける
2. イシューとの紐付け方法：
   - 方法1: プルリクエストのサイドバーにある「Development」セクションから紐付け
     - Development > Link a branch or pull request をクリック
     - 該当するプルリクエストを選択
   - 方法2: プルリクエスト説明文に`Closes #{イシュー番号}`を記載
     - 複数のイシューを閉じる場合は`Closes #123, #456`のように記載
     - マージ時に自動的にイシューがクローズされる
3. プルリクエスト説明文の生成
   - 下書きとしてGitHub Copilot Actionsの「Generate Summary」機能を活用してもよい。
   - コミット履歴から自動的に変更内容をまとめた説明文を生成
   - 生成された内容は翻訳し、必要に応じて編集・補足する
4. プルリクエストのサイズについて
   - 原則として1プルリクエストあたり300-500行程度を目安とする
   - レビュー効率の観点から、以下を参考に分割を検討する：
     - 小さいPR（〜200行）：設定変更、単純なバグ修正、小規模な機能追加
     - 中規模PR（200-500行）：一般的な機能追加、複雑なバグ修正
     - 大規模PR（500行〜）：以下のような変更は分割を検討
       - 新規機能の追加 → 基盤部分とUI部分を分離
       - DB構造の変更 → マイグレーション、モデル、ロジックで分割
       - 広範なリファクタリング → 機能ごとに分割
   - 機械的な変更は例外とする：
     - コードフォーマットの適用
     - ファイル名の変更
     - 定型的なリネーム
   - 分割のコツ：
     - 独立してテスト可能な単位で分割
     - UIとロジックを別PRにする
     - データ構造の変更と利用箇所の修正を分ける
5. レビュー依頼時の注意点
   - レビュー依頼前に自身でセルフレビューを行う
   - 変更内容が分かりやすいようにコミットを整理する
   - WIPラベルを外してからレビューを依頼する
   - レビュアーの負荷を考慮し、適切なタイミングでレビューを依頼する

### マージ戦略
1. 基本方針
   - マージ方式は「Create a merge commit」を使用
   - Squash mergeは履歴が失われるため原則使用しない
   - Rebase and mergeはコミット履歴が改変されるため使用しない
2. マージコミットメッセージ
   - デフォルトのメッセージを使用
   - 必要に応じて追加の文脈情報を記載

### リリースとタグ付け
1. バージョン番号
   - セマンティックバージョニングを採用（`vX.Y.Z`）
     - X: メジャーバージョン（後方互換性のない変更、または大きな機能追加）
     - Y: マイナーバージョン（後方互換性のある機能追加）
     - Z: パッチバージョン（バグ修正）
2. タグ付けのタイミング
   - 本番環境へのデプロイ時に必ずタグを作成
   - GitHub Releasesを使用してタグを作成
   - リリースノートには主な変更内容を記載
3. タグの作成方法
   ```bash
   git tag -a v1.0.0 -m "Release v1.0.0"
   git push origin v1.0.0
   ```

### 緊急時の対応フロー
1. ホットフィックスの場合
   - `hotfix/`ブランチを`main`から作成
   - 修正後、`main`にマージ
   - 以降の開発ブランチは修正済みの`main`から作成される
2. 本番環境のロールバックが必要な場合
   - タグを使用して特定のバージョンに戻す
   - 障害報告とともにイシューを作成
   - 再発防止策を検討・実装

### 自動化設定
1. マージ後の自動デプロイ
   - GitHub Actionsを使用してCI/CDパイプラインを構築
   - マージ後に自動的に本番環境へデプロイ
2. 依存関係の自動更新（Dependabot）

## イシューテンプレート

```markdown
## 概要
<!-- 変更内容を簡潔に説明してください -->

## 目的
<!-- なぜこの変更が必要なのかを説明してください -->

## タスク
- [ ] タスク1
- [ ] タスク2
- [ ] タスク3

## 関連情報
<!-- 関連するドキュメントやイシューへのリンクを記載してください -->
```

## プルリクエストテンプレート

```markdown
## 変更内容
<!-- 変更の概要を簡潔に説明してください -->

- [ ] バグ修正
- [ ] 新機能追加
- [ ] 破壊的変更
- [ ] ドキュメント更新

## チェックリスト
- [ ] テストを追加・更新した
- [ ] ドキュメントを更新した
- [ ] コードレビューを依頼した
- [ ] CIが成功している

## スクリーンショット（UI変更がある場合）
<!-- 変更前後のスクリーンショットを添付してててください -->

## 特記事項
<!-- レビュアーに伝えたい注意点などがあれば記載してください -->

```

### コンフリクト解決
1. 基本方針
   - コンフリクトの解決は変更内容を理解している人が行う
   - 解決が難しい場合は関係者で相談する
2. 解決手順
   - 必ず`git merge --abort`や`git rebase --abort`で戻せる状態を確保
   - コンフリクト箇所の両方の意図を確認
   - 解決後は必ずビルドとテストを実行

### ブランチの管理
1. ブランチの寿命
   - 作業ブランチは5日以内を目安に完了させる
   - 長期化が予想される場合は、事前に小さなタスクに分割
   - 長期ブランチのリスク：
     - メインブランチとの乖離が大きくなり、マージ時のコンフリクトリスクが増大
     - コードレビューが困難になり、品質低下のリスク
     - 他の開発者の作業との競合が発生しやすくなる
     - デプロイまでの時間が長くなり、価値の提供が遅れる
2. 放置ブランチの扱い
   - 1ヶ月以上更新のないブランチは原則削除
   - 必要な場合は新しいブランチを作り直す

### マージの取り消し
1. 基本方針
   - マージの取り消しはGitHubのUI（Revert pull request）またはコマンドラインで操作する
   - コマンドラインでの操作は以下
     ```bash
     # マージコミットの取り消し
     git revert -m 1 <マージコミットのハッシュ>

     # 取り消しの取り消し（再マージ）
     git revert <revertコミットのハッシュ>
     ```
2. 取り消したマージの再適用
   - 方法1: 取り消しPRのRevert pull requestを作成（推奨）
   - 方法2: コマンドラインで取り消しを取り消す
   - 方法3: 新しいブランチで作業をやり直す（変更内容の見直しが必要な場合）
3. 注意点
   - マージの取り消しは履歴に残るため、慎重に判断する
   - 可能な限り、マージ前のレビューで問題を発見することが望ましい
